# ========================================
# RENDER DEPLOYMENT CONFIGURATION
# ========================================
# This file defines services for Render.com deployment
# Render will automatically detect and deploy based on this config

services:
  # ========================================
  # BACKEND API SERVER
  # ========================================
  - type: web
    name: tracker-kpr-api
    runtime: node
    env: node
    region: oregon # Change to your preferred region
    plan: free # Change to 'starter' or 'standard' for production
    buildCommand: npm install
    startCommand: node src/server.js
    rootDir: server
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: MONGODB_URI
        sync: false # Set in Render dashboard (secret)
      - key: JWT_SECRET
        generateValue: true # Auto-generate secure secret
      - key: JWT_EXPIRES_IN
        value: 1h
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: JWT_REFRESH_EXPIRES_IN
        value: 7d
      - key: FRONTEND_URL
        value: https://tracker-kpr-frontend.onrender.com # Update with your frontend URL
      - key: GITHUB_CLIENT_ID
        sync: false # Set in Render dashboard (from GitHub OAuth app)
      - key: GITHUB_CLIENT_SECRET
        sync: false # Set in Render dashboard (from GitHub OAuth app)
      - key: GITHUB_CALLBACK_URL
        value: https://tracker-kpr-api.onrender.com/api/auth/github/callback
      - key: SESSION_SECRET
        generateValue: true # Auto-generate secure secret
      - key: ENCRYPTION_KEY
        generateValue: true # Auto-generate for GitHub token encryption
      - key: GEMINI_API_KEY
        sync: false # Set in Render dashboard (from Google AI Studio)
      - key: COOKIE_SECURE
        value: true
      - key: COOKIE_SAME_SITE
        value: none # Required for cross-origin cookies
      - key: RATE_LIMIT_WINDOW_MS
        value: 900000
      - key: RATE_LIMIT_MAX_REQUESTS
        value: 100
      - key: AUTH_RATE_LIMIT_WINDOW_MS
        value: 900000
      - key: AUTH_RATE_LIMIT_MAX_ATTEMPTS
        value: 5
      - key: MAX_FILE_SIZE
        value: 5242880
      - key: ALLOWED_FILE_TYPES
        value: image/jpeg,image/png,image/jpg,application/pdf
      - key: LOG_LEVEL
        value: info
      - key: BCRYPT_ROUNDS
        value: 10
    healthCheckPath: /api/health
    autoDeploy: true

  # ========================================
  # FRONTEND STATIC SITE
  # ========================================
  - type: web
    name: tracker-kpr-frontend
    runtime: static
    buildCommand: npm install && npm run build
    staticPublishPath: dist
    rootDir: frontend
    envVars:
      - key: VITE_API_URL
        value: https://tracker-kpr-api.onrender.com # Update with your API URL
      - key: VITE_APP_NAME
        value: Tracker KPR
      - key: VITE_APP_VERSION
        value: 1.0.0
      - key: VITE_DEBUG
        value: false
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    autoDeploy: true

# ========================================
# NOTES FOR DEPLOYMENT
# ========================================
# 
# 1. Push this file to your GitHub repository root
# 2. Connect your GitHub repo to Render.com
# 3. Render will auto-detect this file and create all services
# 4. Set these REQUIRED secrets in Render dashboard for the API service:
#    - MONGODB_URI (from MongoDB Atlas)
#    - GITHUB_CLIENT_ID (from GitHub OAuth app)
#    - GITHUB_CLIENT_SECRET (from GitHub OAuth app)
#    - GEMINI_API_KEY (from Google AI Studio)
# 5. Update FRONTEND_URL and API URLs after services are created
# 6. Update GitHub OAuth app callback URL to: https://tracker-kpr-api.onrender.com/api/auth/github/callback
# 7. Free tier services spin down after inactivity - consider Starter plan for production
# 8. After first deployment, update VITE_API_URL in frontend service to actual API URL
